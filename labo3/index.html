<!DOCTYPE HTML>
<html>

<head>
  <meta charset="utf-8">
  <title>Labo 3 - Groupe 1</title>
  <style>
    body{font-family: arial;}
  </style>
</head>
<body>
  <header>
    <h1>Eliminiation de Gauss</h1>
  </header>

  <section>
    <h2>Choix du fichier de la matrice</h2>
    <input type="file" id="filesJson" name="files[]" accept=".json" />
    <output id="list"></output>
  </section>
  <section>
    <h2>Générer une matrice aléatoirement</h2>
    <form id="generateMatrixForm">
      <table id="generateMatrixTable" cellspacing="5px">
        <tr>
          <td><label for="min" >Min : </label></td><td><input type="number" id="min" value="-50"/></td>
          <td><label for="max" >Max : </label></td><td><input type="number" id="max" value="50"/></td>
        </tr>
        <tr>
          <td><label for="dim">n : </label></td><td><input type="number" id="dim" value="3" /></td>
        </tr>
        <tr><td colspan="4" align="right"><input type="submit" id="generateMatrix" value="Générer une matrice" /></td></tr>
      </table>
    </form>
  </section>
  <section>
    <h2>Votre système linéaire</h2>

    <input type="button" id="eliminationGauss" onclick="eliminaionGauss();" value="Calculer" />
    <table id="tableMatrix">
    </table>

    <table id="tableMatrixResult">
    </table>
  </section>

  <script>

    Matrix = function(n) {
      this.n = n;
      this.rows = [];
    }

    Matrix.prototype = {
      copy : function() {
        var m = new Matrix(this.n);
        for(var i = 0 ; i<this.n ; i++) {
          for(var j = 0 ; j<this.n ; j++) {
            m.put(i, j, parseFloat(this.get(i, j)));
          }
        }
        return m;
      },

      put : function(row, column, value) {
        if(this.rows[row] == undefined){
          this.rows[row] = [];
        }
        var row = this.rows[row];
        row[column] = value;
      },

      get : function(row, column) {
        return this.rows[row][column];
      },

      display : function(tableID) {

        //clearTable(tableID);
        var table = document.getElementById(tableID);
        var newRow, column, index=0, cell=0;
        for(var i = 0; i<this.rows.length ; i++) {
          newRow = table.insertRow(-1);
          for(var j = 0; j<this.rows[i].length ; j++) {
            column = newRow.insertCell(j);
            column.align = "center";
            column.innerHTML = this.rows[i][j];
          }
        }
      }
    }

    var matrix, matrixUnknow, matrixResult, matrixGauss;

    function changeFileJson(evt) {
      file = evt.target.files[0];
      var fileJson = evt.target;

      var reader = new FileReader();
      reader.onload = function(){
        var text = reader.result;
        var parseText = JSON.parse(text);
        createMatrix(parseText);
      };
      reader.readAsText(fileJson.files[0]);
    }

    function createMatrix(textJson) {
      if(textJson == undefined || textJson.n == undefined || textJson.A == undefined || textJson.B == undefined) {
        alert("Le fichier de la matrice comporte une erreur!");
        return;
      }

      matrix = new Matrix(textJson.n);
      matrixResult = new Matrix(textJson.n);
      matrixUnknow = new Matrix(textJson.n);

      var decal = textJson.n;
      var size = Math.pow(decal, 2);
      var row=0, col=0;
      for(var i = 0 ; i<size ; i++) {
        matrix.put(row, col++, textJson.A[i]);
        if((i+1)%decal == 0) {
          col=0;
          row++;
        }
      }

      for(var i = 0 ; i<decal ; i++) {
        matrixUnknow.put(i, 0, "x"+i);
        matrixResult.put(i, 0, textJson.B[i]);
      }

      matrix.display("tableMatrix");
    }

    function generateMatrix(n, min, max) {
      var str = "{\"n\":["+n+"],";
      str += "\"A\":[";

      var nbElement = Math.pow(n, 2);
      for(var i = 0 ; i<nbElement ; i++) {
        var val = getRandomInt(min, max);
        str += val;
        if(i+1 < nbElement) {
          str+=",";
        }
      }
      str+="],\"B\":[";
      for(var i = 0 ; i<n ; i++) {
        var val = getRandomInt(min, max);
        str += val;
        if(i+1 < n) {
          str+=",";
        }
      }
      str+="]}";

      var parseText = JSON.parse(str);
      createMatrix(parseText);
    }

    function getRandomInt(min, max) {
      return Math.floor(Math.random() * (max - min)) + min;
    }

    function eliminaionGauss() {
      if(matrix == undefined) {
        alert("Aucune matrix choisie!");
        return;
      }

      matrixGauss = matrix.copy();

      var x=[], p,s, i,j,k, val=0;
      for(k = 0 ; k < matrixGauss.n-1 ; k++) {
        if(matrixGauss.get(k, k) == 0) {
          alert("Un pivot nul => methode de Gauss non applicable!");
          return;
        }

        //Reduction
        for(i = k+1 ; i<matrixGauss.n ; i++) {
          p = matrixGauss.get(i, k)/matrixGauss.get(k, k);
          for(j = k ; j<matrixGauss.n ; j++) {
            val = (matrixGauss.get(i, j)-p*matrixGauss.get(k, j)).toFixed(2);
            matrixGauss.put(i, j, parseFloat(val));
          }
          val = (matrixResult.get(i, 0)-p*matrixResult.get(k, 0)).toFixed(2);
          matrixResult.put(i, 0, parseFloat(val));
        }
      }

      //Resoluton
      for(i = matrixGauss.n-1 ; i>=0 ; i--) {
        s=0;
        for(j = i+1 ; j<matrixGauss.n ; j++) {
          s=s+matrixGauss.get(i, j)*x[j];
        }
        x[i]=(matrixResult.get(i, 0)-s)/matrixGauss.get(i, i);
      }
/*
      var eps=1e-4;
      for(i = 0 ; i<matrix.n ; i++) {
        for(j = 0 ; j<matrix.n ; j++) {
          if(Math.abs(matrix.get(i, j) < eps)) {
            matrix.put(i, j, 0);
          }
        }
        if(Math.abs(matrixResult.get(i, 0) < eps)) {
          matrixResult.put(i, 0, 0);
        }
      }*/

      matrixGauss.display("tableMatrixResult");
      matrixResult.display("tableMatrixResult");
    }

    function eliminaionGaussWithPartialPivot() {
      if(matrix == undefined) {
        alert("La matrice n'est pas définie.");
        return;
      }

      var r = -1;

      for(var j = 0 ; j<matrix.n ; j++) {
        console.log("\n\nj="+j+"\n");
        console.log(matrix);
         var k = choicePivot(j, r);
         console.log("k = "+k);

         if(matrix.get(k, j) != 0) {
           r++;
           console.log("r = "+r);
           var akj = parseFloat(matrix.get(k, j));
           console.log("akj ("+k+";"+j+") = "+matrix.get(k, j));
           for(var i = 0 ; i<matrix.n ; i++) {
            var val = matrix.get(k, i)/akj;
            matrix.put(k, i, val);
            console.log("val/akj = "+val);
             //matrix.get(k, i) /= akj;
           }

           var val = matrixResult.get(k, 0)/akj;
           matrixResult.put(k, 0, val);
           console.log("val/akj = "+val);
           //matrixResult.get(k, 0) /= akj;

           if(r != k) {
             for(var i = 0 ; i<matrix.n ; i++) {
               var tmp = matrix.get(r, i);
               matrix.put(r, i, matrix.get(k, i));
               matrix.put(k, i, tmp);
               //swap(matrix.get(r, i), matrix.get(k, i));
             }
             var tmp = matrixResult.get(r, 0);
             matrix.put(r, 0, matrix.get(k, 0));
             matrix.put(k, 0, tmp);
             //swap(matrixResult.get(r, 0), matrixResult.get(k, 0));
           }

           for(var i = 0 ; i<matrix.n ; i++) {
             if(i != r) {
               var aij = matrix.get(i, j);
               for(var l = 0 ; l<matrix.n ; l++) {
                 var result = matrix.get(i, l) - (aij * matrix.get(r, l));
                 console.log("calc : "+matrix.get(i, l)+" - ( "+aij+" * "+matrix.get(r, l)+" ) => result = "+result);
                 matrix.put(i, l, result);
               }
               var result = matrixResult.get(i, 0) - (aij * matrixResult.get(r, 0));
               console.log("calc : "+matrixResult.get(i, 0)+" - ( "+aij+" * "+matrixResult.get(r, 0)+" ) => result = "+result);
               matrixResult.put(i, 0, result);
             }
           }
         }
      }
      matrix.display("tableMatrixResult");
    }

    function clearTable(tableID) {
      var table = document.getElementById(tableID);
      var rowCount = table.rows.length;
      while(rowCount--) table.deleteRow(rowCount);
    }

    //Choix du pivot partiel
    function choicePivot(j, row) {

      var index = row+1;
      for(var i = row+1 ; i<matrix.n ; i++) {
        if(Math.abs(matrix.get(i, j)) > Math.abs(matrix.get(index, j))) {
          index = i;
        }
      }
      return index;
    }

    document.getElementById("filesJson").addEventListener("change", changeFileJson, false);

    var form = document.getElementById("generateMatrixForm");
    form.onsubmit = function(event) {
      event.preventDefault();
      var min = parseInt(document.getElementById("min").value);
      var max = parseInt(document.getElementById("max").value);
      var n = parseInt(document.getElementById("dim").value);
      generateMatrix(n, min, max);
    }

  </script>
</body>

</html>
